- work
  - 研究 mqtt 细节：Retain-Flag，Persistent Session，Keep Alive
- mqtt
  - Time decoupling: Publisher and subscriber do not need to run at the same time.
  - The broker is able to store messages for clients that are not online. (This requires two conditions: client has connected once and its session is persistent and it has subscribed to a topic with Quality of Service greater than 0).
  - Differences from message queue 
    - A message queue stores message until they are consumed
    - A message will only be consumed by one client
    - Queues are named and must be created explicitly
  - CONNACK
    - The session present flag indicate, whether the broker already has a persistent session of the client from previous interactions.
  - PUBLISH
    - Retain-Flag
      - This flag determines if the message will be saved by the broker for the specified topic as last known good value. New clients that subscribe to that topic will receive the last retained message on that topic instantly after subscribing. 
    - The client, who initially published the message is only concerned about delivering the publish message to the broker. From there on it is the responsibility of the broker to deliver the message to all subscribers.
  - Qos
    - Each packet identifier (used for QoS 1 and QoS 2) is unique between one client and a broker and not between all clients. 
    - You need to get every message and your use case can handle duplicates.
    - broker publish to 多个 client 时，packetId 相同吗？
    - 2
      - 如果 sender 没有收到 PUBREC，将怎么办？在多久之后会重发？
  - Persistent Session
    - But what happens if a client does not come online for a long time? The constraint for storing messages is often the memory limit of the operating system. 
  - Retained message 
    - The subscribing client can identify if a received message was a retained message or not, because the broker sends out retained messages with the retained flag still set to true.
  - Last will and Testament
    - 通过这个处理 router 断线的情况
    - after a client has connected to a broker, it will send a retained message to the topic client1/status with the payload “online“. When connecting to the broker, the client sets the LWT message on the same topic to the payload “offline” and marks this LWT message as a retained message.
  - Keep Alive
    - A disconnected client will most likely try to connect again. It could be the case that the broker still has an half-open connection for the same client. In this scenario the MQTT will perform a so-called client take-over. The broker will close the previous connection to the same client (determined by the same client identifier) and establishes the connection with the newly connected client. 