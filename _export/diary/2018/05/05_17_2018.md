- work
  - mqtt 特性验证
    - 离线消息验证
      - 消息存在的时长：
        > A often asked question is how long is a session stored on the broker. The easy answer is until the clients comes back online and receives the message. But what happens if a client does not come online for a long time? The constraint for storing messages is often the memory limit of the operating system.
      - 验证 persistent session 和 qos 对离线消息的影响(是否能收到离线消息)
        - persistent session: True, qos: 1 (期望为"是"，cleanSession 设置为 False 会连接超时，为查明原因)
        - persistent session: True, qos: 0 (期望为"否"，cleanSession 设置为 False 会连接超时，为查明原因)
        - persistent session: False, qos: 1 (否)
        - persistent session: False, qos: 0 (否)
    - Qos 等级建议
      - Qos 等级特性
        - 2: 耗时耗资源,不建议
        - 1: 需要做重复消息容错
        - 0: 建议做成这样，如果消息没收到，那么将显示设备未连接
      - 结论: server 的 PUBLISH 设为 0，SUBSCRIBE 设为 1，router 的 PUBLISH 设为 1，SUBSCRIBE 设为 0。这样的结果是：
        - server 到 router 的消息都只发一次，如果 router 没收到，就报“未连接到 router”(router 不需要做重复消息容错)
        - router 到 server 的消息至少送达一次，这样只要是 router 处理过的 server->router 消息，server 都会收到返回的消息，不会出现 router 明明处理了的情况，server 还是报“未连接到 router”。而 server 如果同一个 req_id 收到多次回复是不会处理的。
    - 验证 Downgrade of QoS，多终端订阅 Qos1 会是什么情况
    - 用 LWT(last will and testament) 记录 online/offline
      > after a client has connected to a broker, it will send a retained message to the topic client1/status with the payload “online“. When connecting to the broker, the client sets the LWT message on the same topic to the payload “offline” and marks this LWT message as a retained message.
      - 操作步骤
        - 当 router 上线时，发送一个 topic 为 router/<sn>/status 的消息，Qos 为1。server 订阅 router/+/status，这样可以保证 server 确定知晓 router 的上线，即使 server 在 router 上线当时是挂掉的。
        - 当 router 发送 CONNECT 请求时，lastWillTopic = router/<sn>/status，lastWillQos = 1，lastWillMessage = offline，lastWillRetain = true。可以保证 server 知晓 router 的下线。
      - 好处：如果确定知道 router 的下线，就不用每次等到 timeout 才返回 can't connect to router. 另一个附带好处是在调试阶段可以更方便的监控 router 的离线状态以便分析原因。 
    - retain-flag
    - 重联并不影响，但是 router 断线还是疑点
  - mqtt 改造建议
  - 改 bug
  - 确定 console 需求
  
